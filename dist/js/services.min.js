(()=>{"use strict";class t{constructor(t){this.savedServices,this.savedContent,this.step=0,this.calculator=t,this.wrapperElement=document.querySelector("#calculate-wrapper"),this.calculateContent=document.querySelector("#calculate-content"),this.stepTemplate=document.querySelector("#step-template").content.firstElementChild,this.textTemplate=document.querySelector("#input-text").content.firstElementChild,this.radioTemplate=document.querySelector("#input-radio").content.firstElementChild,this.checkboxTemplate=document.querySelector("#input-checkbox").content.firstElementChild,this.result,this.createCalculator(),this.initPrevButton()}initPrevButton(){this.wrapperElement.querySelector("#prev-button").addEventListener("click",(()=>{delete this.result[this.step],this.step-=2,this.step<0?this.reInitCalculator():this.nextStep()}))}reInitCalculator(){this.calculateContent.innerHTML=this.savedContent,document.querySelector(".main").append(this.savedServices),this.wrapperElement.classList.remove("calculator"),document.querySelector(".main").classList.remove("calculator"),function(){function t(t){t.forEach((t=>{t.isIntersecting&&t.target.classList.add("appear")}))}setTimeout((()=>{let e=document.querySelectorAll("[scroll]"),s={.7:[]};e.forEach((t=>{let e=t.getAttribute("scroll");e=""===e?.7:e,s[e]?s[e].push(t):s[e]=[t]})),Object.keys(s).forEach((e=>{const i=new IntersectionObserver(t,{threshold:e});s[e].forEach((t=>{i.observe(t)}))}))}),500)}(),this.createCalculator()}createCalculator(){const t=document.querySelector("#create-calculator"),e=document.querySelector("#services-services");this.result={},this.step=0,t.addEventListener("click",(()=>{Array.from(e.querySelector(".services__list").children).forEach((t=>t.classList.remove("appear"))),this.savedServices=e,this.savedContent=this.calculateContent.innerHTML,e.remove(),this.wrapperElement.classList.add("calculator"),document.querySelector(".main").classList.add("calculator"),this.nextStep()}))}initStep(t){this.calculateContent.innerHTML="";const e=this.stepTemplate.cloneNode(!0);this.calculateContent.append(e),e.querySelector("#step-step").textContent=t.step,e.querySelector("#step-title").textContent=t.name,"radio"===t.type?this.initRadioStep(t,e):"text"===t.type?this.initTextStep(t,e):"checkbox"===t.type&&this.initCheckboxStep(t,e),setTimeout((()=>e.classList.add("show")),0)}initTextStep(t,e){const s=this.textTemplate.cloneNode(!0);e.querySelector("#step-inputs").append(s),s.setAttribute("placeholder",t.placeholder),void 0!==this.result[this.step]&&(s.value=this.result[this.step]),s.addEventListener("click",(()=>s.classList.remove("warning"))),this.submitButtonStep(e,(()=>{if(!this.isCorrectInputedText(s.value))return void s.classList.add("warning");const t=parseFloat(s.value.trim());this.result[this.step]=t,this.nextStep()}))}isCorrectInputedText(t){return!(/[^0-9 .,]/.test(t)||(t.match(/[,.]/g)||[]).length>1||""===t||!(!/[,.]/.test(t)||/[,.]\d/.test(t)&&/\d[,.]/.test(t)))}initRadioStep(t,e){const s=[];t.variants.forEach(((t,i)=>{const c=this.radioTemplate.cloneNode(!0);e.querySelector("#step-inputs").append(c);const l=c.querySelector("input");this.result[this.step]===i&&(l.checked=!0),l.setAttribute("id","radio"+i),s.push(l),l.addEventListener("change",(()=>{s.forEach((t=>t.classList.remove("warning")))}));const r=c.querySelector("label");r.textContent=t.name,r.setAttribute("for","radio"+i)})),this.submitButtonStep(e,(()=>{let t;s.forEach(((e,s)=>t=e.checked?s:t)),void 0!==t?(this.result[this.step]=t,this.nextStep()):s.forEach((t=>t.classList.add("warning")))}))}initCheckboxStep(t,e){const s=t.variants[this.result[this.step-1]],i=[];s.forEach(((t,s)=>{const c=this.checkboxTemplate.cloneNode(!0);e.querySelector("#step-inputs").append(c);const l=c.querySelector("input");l.setAttribute("id","checkbox"+s),i.push(l),l.addEventListener("change",(()=>{i.forEach((t=>t.classList.remove("warning")))}));const r=c.querySelector("label");r.append(t.name),r.setAttribute("for","checkbox"+s)})),this.submitButtonStep(e,(()=>{const t=i.map(((t,e)=>t.checked?e:-1)).filter((t=>-1!==t));0!==t.length?(this.result[this.step]=t,this.initResultStep()):i.forEach((t=>t.classList.add("warning")))}))}submitButtonStep(t,e){const s=t.querySelector("#submit-step");s.addEventListener("click",(t=>{t.preventDefault(),e(),s.blur()}))}nextStep(){this.step++,1!==this.step?this.initStep(this.calculator.steps[this.step][this.result[1]]):this.initStep(this.calculator.steps[1][0])}initResultStep(){const[t,e]=this.calculateResult();if(0===t&&e)return void this.initConsultResult();const s=document.querySelector("#result-calculator").content.firstElementChild.cloneNode(!0);this.calculateContent.innerHTML="",this.calculateContent.append(s),this.wrapperElement.classList.add("result"),this.calculateContent.querySelector("#result-container").textContent=(100*Math.round(t/100)).toLocaleString(),e&&(this.calculateContent.querySelector("#result-description").innerHTML='<div class="calculate-result__info">Сумма определена без учета пунктов, которых не было в списке, для получения более полной информации заполните анкету.</div><div class="calculate-result__info calculate-result__info_first">Данная информация является справочной и не является публичной офертой.</div> <div class="calculate-result__info">Окончательный расчет стоимости после обследования объекта.</div>',this.calculateContent.querySelector("#result-description").classList.add("outoflist"),this.calculateContent.querySelector(".calculate-result__title").classList.add("outoflist")),setTimeout((()=>s.classList.add("show")),0)}initConsultResult(){const t=document.querySelector("#result-consult").content.firstElementChild.cloneNode(!0);this.wrapperElement.classList.add("result"),this.calculateContent.innerHTML="",this.calculateContent.append(t),setTimeout((()=>t.classList.add("show")),0)}calculateResult(){let t;return t=1===this.result[1]?this.calculateLinearResult():this.calculateCapitalResult(),t}calculateLinearResult(){const t=this.calculator.steps[3][1].variants[this.result[3]].k;let e=!1;const s=this.result[4].map((t=>this.calculator.steps[4][1].variants[this.result[3]][t].price)).reduce(((t,s)=>s>0?t+s:(e=!0,t)),0);return[this.result[2]*t*s,e]}calculateCapitalResult(){const t=this.calculator.steps[2][0].variants[this.result[2]].k,e=this.calculator.steps[4][0].variants[this.result[4]].k;let s=!1;const i=this.result[5].map((t=>this.calculator.steps[5][0].variants[this.result[4]][t].price)).reduce(((t,e)=>e>0?t+e:(s=!0,t)),0);return[this.result[3]*t*e*i,s]}}!async function(){const e=await async function(){return t=t=>t,fetch("https://bimcod.pythonanywhere.com/api/v1/getCalculator",{method:"GET",headers:{"Content-Type":"application/json;charset=utf-8"}}).then((t=>t.json())).then(t);var t}();new t(e.calculator)}()})();